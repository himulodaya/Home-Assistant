blueprint:
  name: Den Lights Smart Automation
  description: |
    Automates den lights based on time, media player state, door sensor, and ambient conditions.
    - Supports brightness transitions from 10% to 100% during sunset.
    - Gradual dimming from 22:30 to midnight.
    - Adjusts lighting based on TV (media_player) and door sensor.
  domain: automation
  input:
    light_target:
      name: Light
      selector:
        target:
          entity:
            domain: light
    media_player:
      name: Media Player (TV)
      selector:
        entity:
          domain: media_player
    door_sensor:
      name: Door Sensor
      selector:
        entity:
          domain: binary_sensor
    sunrise:
      name: Sunrise Time
      default: sunrise
      selector:
        entity:
          domain: sun
    sunset:
      name: Sunset Time
      default: sunset
      selector:
        entity:
          domain: sun

automation:
  - alias: Den Lights Based on Time, TV and Door
    trigger:
      - platform: state
        entity_id: !input media_player
      - platform: state
        entity_id: !input door_sensor
        to: 'on'
      - platform: time_pattern
        minutes: "/5"

    condition: []

    action:
      - choose:
          - conditions:
              - condition: state
                entity_id: !input door_sensor
                state: 'on'
            sequence:
              - service: light.turn_on
                target: !input light_target
                data:
                  brightness_pct: 60
              - delay: "00:01:00"
              - choose:
                  - conditions:
                      - condition: state
                        entity_id: !input media_player
                        state: 'on'
                    sequence:
                      - service: light.turn_on
                        target: !input light_target
                        data:
                          brightness_pct: 10
                  - conditions:
                      - condition: state
                        entity_id: !input media_player
                        state: 'off'
                    sequence:
                      - service: light.turn_off
                        target: !input light_target

          - conditions:
              - condition: state
                entity_id: !input media_player
                state: 'on'
              - condition: time
                after: "00:00:00"
                before: "06:00:00"
            sequence:
              - service: light.turn_on
                target: !input light_target
                data:
                  brightness_pct: 10

          - conditions:
              - condition: sun
                after: sunset
                before: "22:30:00"
              - condition: state
                entity_id: !input media_player
                state: 'off'
            sequence:
              - service: light.turn_on
                target: !input light_target
                data:
                  brightness_pct: 100

          - conditions:
              - condition: time
                after: "22:30:00"
                before: "00:00:00"
            sequence:
              - service: light.turn_on
                target: !input light_target
                data:
                  brightness_pct: 10

        default:
          - service: light.turn_off
            target: !input light_target
